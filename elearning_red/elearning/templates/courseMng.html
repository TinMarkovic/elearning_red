{% extends "base.html" %}
{% block title %} Course {% endblock title %}
{% block content %}
{% csrf_token %}
<h1> Course Management </h1>
<a href="{% url "elearning:listCourses" %}">Back to course list</a> <br><br>
<a href="{% url "elearning:manageStudents" course_id=course_id %}">Add/remove students</a>
<h2> Sections: <a href="javascript:void(0)" class="btn btn-raised btn-success" id="confirmSort">CONFIRM SORT ORDER</a></h2>

<div class="col-md-8">
        <div id="sortable">
                {% if not query_results %}
                <div class="panel panel-default">
                        <div class="panel-body">Add a new section!</div>
                </div>
                {% else %}
                {% for item in query_results|dictsort:"index" %}

                 <div class="panel panel-success section-item" id="{{item.id}}">
                        <div class="panel-heading">
                                <h3 class="panel-title">{{item.name}} 
                                <a href="#"><i class="material-icons pull-right deleteSection">delete</i></a>
                                <span class="col-md-1 pull-right"></span>  
                                <a href="{% url "elearning:editSection" course_id item.id %}"> 
                                    <i class="material-icons pull-right">edit</i>
                                </a>
                                <span class="col-md-1 pull-right"></span>  
                                <a href="{% url "elearning:manageSection" course_id item.id %}">
                                    <i class="material-icons pull-right">playlist_add</i>
                                </a></h3>
                        </div>
                        <div class="panel-body selection-item-body">
                            <ul class="list-group" id="{{item.id}}l">
                            </ul>
                        </div>
                </div>
                {% endfor %}
                {% endif %}
        </div>
        <div class="panel panel-default">
                <div class="panel-body">
                    <a href="{% url "elearning:newSection" course_id %}" class="btn btn-default btn-lg btn-block btn-raised">New Section</a>
                </div>
        </div>
</div>
{% endblock content %}

{% block navigation %}
<div class="navbar navbar-danger">


  <div class="container-fluid">
 
    


    <div class="navbar-collapse collapse navbar-danger-collapse">
      <ul class="nav navbar-nav" id="menu">
       
             <li><ul class="breadcrumb">
            <li><a href={% url "elearning:homepage" %} class="btn btn-default"><b>Home</b></a></li>
            <li><a href={% url "elearning:listCourses" %} class="btn btn-default"><b>List of courses</b></a></li>
            <li class="active"><b>{{course.name}}</b></a></li>
           
            </ul></li>
            

          
        
      </ul>
      
          
        </li>
      </ul>
    </div>
  </div>
</div>


<div class="container-fluid">

          <button type="button" class="hamburger is-closed" data-toggle="offcanvas">
          <span class="hamb-top"></span>
          <span class="hamb-middle"></span>
          <span class="hamb-bottom"></span>
          </button>
         
          </div>
{% endblock navigation %}

{% block script %}-
<script>
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
$(document).ready(function () {
    $("#confirmSort").hide();
    $(".selection-item-body").hide();
    csrftoken = getCookie("csrftoken");
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    });
    $(function() {
        $( "#sortable" ).sortable({
            axis: "y",
            cursor: "move",
            scroll: false
        });
        $( "#sortable" ).disableSelection();
    });
    $( "#sortable" ).on( "sortstop", function( event, ui ) {
            $("#confirmSort").show();
    });
    $( "#confirmSort" ).on( "click", function( event, ui ) {
        var sortedIDs = $( "#sortable" ).sortable( "toArray" );
            $.ajax({
                 type:"POST",
                 url:"/ajax/modify-section-order/",
                 data: {
                        'course_id' : {{course_id}},
                        'neworder': JSON.stringify(sortedIDs)
                        },
                 success: function(){
                    }
            });
        $("#confirmSort").hide();
    });
    $( ".section-item" ).on( "click", function( event, ui ) {
        var section_id = $(this).attr('id');
        if ( !( $(this).attr('loaded') )){
            $(this).attr('loaded', true);
            request = $.ajax({
                 type:"POST",
                 url:"/ajax/get-blocks-list/",
                 data: {
                        'section_id' : section_id
                        }
                });
            request.done(function (response){
                var itemset = JSON.parse(response);
                var listID = "#"+section_id+"l";
                $listSelector = $(listID);
                for(item of itemset) {
                    $listSelector.append('<li class="list-group-item"> '+item.fields.index + '. '+item.fields.name+'</li>');
                    console.log('<li class="list-group-item"> '+item.fields.index + '. '+item.fields.name+'</li>');
                }
        });}
        $(this).children(".selection-item-body").toggle();
    });
    $( ".deleteSection" ).on( "click", function( event, ui ) {
        $element = $(this).parents(".panel-success");
        var section_id = $element.attr("id");
        console.log("Deleting " + section_id);
        if(confirm("Are you certain you want to delete this section?")){
            $.ajax({
                 type:"DELETE",
                 url:"/courses/manage/" + {{course_id}} + 
                 "/section/edit/" + section_id,
                 data: {},
                 success: function(response){
                    console.log(response);
                    $element.remove();
                }
            });
        }
    });
});
</script>
{% endblock script %}